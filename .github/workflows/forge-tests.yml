# ⚒️ The Forge — CI Test Pipeline
#
# Runs the Forge test suite across two layers:
#   - Layer 1 (Static/CI): Always runs on push/PR to main/develop
#   - Layer 2 (Integration): Runs after Layer 1 passes
#   - E2E: Runs only on push to main (requires claude CLI, continue-on-error)
#
# Trigger paths: Only runs when forge-plugin/** or this workflow changes.

name: Forge Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'forge-plugin/**'
      - '.github/workflows/forge-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'forge-plugin/**'
      - '.github/workflows/forge-tests.yml'

permissions:
  contents: read

jobs:
  layer1-ci:
    name: "Layer 1 — Static/CI Tests"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install pytest pyyaml jsonschema

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y jq shellcheck

      - name: Run Layer 1 pytest tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/ -v --tb=short

      - name: Run hook syntax checks
        run: bash forge-plugin/tests/layer1/test_hook_syntax.sh

      - name: Run shellcheck linting
        run: bash forge-plugin/tests/layer1/test_shellcheck.sh

  # -------------------------------------------------------------------------
  # PHASE 2 VALIDATION JOBS (Migrated from agentic workflows)
  # Run in parallel with layer1-ci - validate structure and conventions
  # -------------------------------------------------------------------------

  validate-agents:
    name: "Validate Agent Configs"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml jsonschema

      - name: Run agent validation tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/test_agent_validation.py -v --tb=short

  validate-skills:
    name: "Validate Skill Structure"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml

      - name: Run skill validation tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/test_skill_validation.py -v --tb=short

  validate-hooks:
    name: "Validate Hook Quality"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y jq shellcheck

      - name: Run hook quality checks
        run: bash forge-plugin/tests/layer1/test_hook_quality.sh

  validate-xrefs:
    name: "Validate Cross-References"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml jsonschema

      - name: Run cross-reference validation tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/test_cross_references.py -v --tb=short

  validate-context:
    name: "Validate Context Integrity"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml

      - name: Run context integrity tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/test_context_integrity.py -v --tb=short

  validate-conventions:
    name: "Validate Conventions"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml

      - name: Run convention validation tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/test_conventions.py -v --tb=short

  # Content duplication detection removed from CI — the 37-minute fuzzy
  # similarity analysis is better handled by the forge-duplication-detector
  # agentic workflow which can reason about intent vs. template boilerplate.

  health-aggregator:
    name: "Health Score Aggregator"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs:
      - layer1-ci
      - validate-agents
      - validate-skills
      - validate-hooks
      - validate-xrefs
      - validate-context
      - validate-conventions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Generate health report
        run: bash forge-plugin/tests/layer1/test_health_score.sh

      - name: Upload health report artifact
        uses: actions/upload-artifact@v4
        with:
          name: forge-health-report
          path: forge-plugin/tests/.health-report.json
          retention-days: 30

  # -------------------------------------------------------------------------
  # LAYER 2 INTEGRATION TESTS
  # -------------------------------------------------------------------------

  layer2-hooks:
    name: "Layer 2 — Integration Tests"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: health-aggregator
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install pytest pyyaml jsonschema

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run hook integration tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer2/hooks/ -v --tb=short

      - name: Run memory lifecycle tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer2/memory/ -v --tb=short

      - name: Run context loading tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer2/context/ -v --tb=short

  layer2-e2e:
    name: "E2E Tests (claude CLI)"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: layer2-hooks
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for claude CLI
        id: check-claude
        run: |
          if command -v claude &>/dev/null; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "⚠ claude CLI not available — E2E tests skipped"
          fi

      - name: Run E2E plugin loading test
        if: steps.check-claude.outputs.available == 'true'
        run: bash forge-plugin/tests/layer2/e2e/test_plugin_loading.sh

      - name: Run E2E command execution test
        if: steps.check-claude.outputs.available == 'true'
        run: bash forge-plugin/tests/layer2/e2e/test_command_execution.sh

      - name: Run E2E skill invocation test
        if: steps.check-claude.outputs.available == 'true'
        run: bash forge-plugin/tests/layer2/e2e/test_skill_invocation.sh
