# ⚒️ The Forge — CI Test Pipeline
#
# Runs the Forge test suite across two layers + quality validation:
#   - Layer 1 (Static/CI): Always runs on push/PR to main/develop
#   - Quality Gate: Migrated validation checks (context, duplication, conventions, xrefs)
#   - Layer 2 (Integration): Runs after Layer 1 passes
#   - E2E: Runs only on push to main (requires claude CLI, continue-on-error)
#
# Also runs weekly (Sunday 9am UTC) as a comprehensive scheduled health check,
# replacing 7 separate agentic validator workflows.
#
# Trigger paths: Only runs when forge-plugin/** or workflow config changes.

name: Forge Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'forge-plugin/**'
      - '.github/workflows/forge-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'forge-plugin/**'
      - '.github/workflows/forge-tests.yml'
  schedule:
    - cron: "0 9 * * 0"  # Weekly Sunday 9am UTC — replaces agentic validator schedules

permissions:
  contents: read

jobs:
  layer1-ci:
    name: "Layer 1 — Static/CI Tests"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install pytest pyyaml jsonschema

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y jq shellcheck

      - name: Run Layer 1 pytest tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/ -v --tb=short

      - name: Run hook syntax checks
        run: bash forge-plugin/tests/layer1/test_hook_syntax.sh

      - name: Run shellcheck linting
        run: bash forge-plugin/tests/layer1/test_shellcheck.sh

  layer2-hooks:
    name: "Layer 2 — Integration Tests"
    runs-on: ubuntu-latest
    needs: layer1-ci
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Python dependencies
        run: pip install pytest pyyaml jsonschema

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run hook integration tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer2/hooks/ -v --tb=short

      - name: Run memory lifecycle tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer2/memory/ -v --tb=short

      - name: Run context loading tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer2/context/ -v --tb=short

  layer2-e2e:
    name: "E2E Tests (claude CLI)"
    runs-on: ubuntu-latest
    needs: layer2-hooks
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    continue-on-error: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for claude CLI
        id: check-claude
        run: |
          if command -v claude &>/dev/null; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "⚠ claude CLI not available — E2E tests skipped"
          fi

      - name: Run E2E plugin loading test
        if: steps.check-claude.outputs.available == 'true'
        run: bash forge-plugin/tests/layer2/e2e/test_plugin_loading.sh

      - name: Run E2E command execution test
        if: steps.check-claude.outputs.available == 'true'
        run: bash forge-plugin/tests/layer2/e2e/test_command_execution.sh

      - name: Run E2E skill invocation test
        if: steps.check-claude.outputs.available == 'true'
        run: bash forge-plugin/tests/layer2/e2e/test_skill_invocation.sh

  # ===================================================================
  # Quality Gate — Migrated from agentic workflows
  # Replaces: agent-validator, skill-validator, hook-checker,
  #           context-pruner, xref-checker, duplication-detector,
  #           convention-enforcer, health-dashboard
  # ===================================================================

  validate-context:
    name: "Quality Gate — Context Integrity"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml jsonschema

      - name: Run context integrity tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/test_context_integrity.py -v --tb=short

  detect-duplicates:
    name: "Quality Gate — Duplication Detection"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml

      - name: Run duplication tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/test_duplication.py -v --tb=short

  enforce-conventions:
    name: "Quality Gate — Convention Enforcement"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml

      - name: Run convention tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/test_conventions.py -v --tb=short

  check-xref-links:
    name: "Quality Gate — Cross-Reference Links"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pytest pyyaml

      - name: Run cross-reference link tests
        working-directory: forge-plugin/tests
        run: python -m pytest layer1/test_xref_links.py -v --tb=short

  quality-report:
    name: "Quality Gate — Summary"
    needs: [layer1-ci, validate-context, detect-duplicates, enforce-conventions, check-xref-links]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## ⚒️ Forge Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Layer 1 (Static) | ${{ needs.layer1-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Context Integrity | ${{ needs.validate-context.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duplication Detection | ${{ needs.detect-duplicates.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Convention Enforcement | ${{ needs.enforce-conventions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cross-Reference Links | ${{ needs.check-xref-links.result }} |" >> $GITHUB_STEP_SUMMARY
