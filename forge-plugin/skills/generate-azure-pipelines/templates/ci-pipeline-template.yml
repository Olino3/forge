# CI Pipeline for {{PROJECT_NAME}}
# Generated by Claude Code skill:generate-azure-pipelines
# Runtime: {{RUNTIME}} {{VERSION}}

trigger:
  branches:
    include:
      - main
      - develop
      - feature/*
  {{#PATH_FILTERS}}
  paths:
    include:
{{#INCLUDE_PATHS}}
      - {{PATH}}
{{/INCLUDE_PATHS}}
    {{#EXCLUDE_PATHS}}
    exclude:
{{#EXCLUDE_PATHS_LIST}}
      - {{PATH}}
{{/EXCLUDE_PATHS_LIST}}
    {{/EXCLUDE_PATHS}}
  {{/PATH_FILTERS}}

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: '{{VM_IMAGE}}'

variables:
  buildConfiguration: 'Release'
  {{#ADDITIONAL_VARIABLES}}
  {{KEY}}: '{{VALUE}}'
  {{/ADDITIONAL_VARIABLES}}

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        steps:
          {{#USE_PYTHON}}
          - task: UsePythonVersion@0
            inputs:
              versionSpec: '{{VERSION}}'
            displayName: 'Use Python {{VERSION}}'

          {{#USE_POETRY}}
          - script: |
              pip install poetry
              poetry install
            displayName: 'Install dependencies with Poetry'

          - script: |
              poetry run pytest {{TEST_PATH}}
            displayName: 'Run tests'

          - script: |
              poetry build
            displayName: 'Build package'
          {{/USE_POETRY}}

          {{#USE_PIP}}
          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies with pip'

          - script: |
              pytest {{TEST_PATH}}
            displayName: 'Run tests'

          - script: |
              python setup.py sdist bdist_wheel
            displayName: 'Build package'
          {{/USE_PIP}}
          {{/USE_PYTHON}}

          {{#USE_NODEJS}}
          - task: UseNodeVersion@0
            inputs:
              versionSpec: '{{VERSION}}'
            displayName: 'Use Node.js {{VERSION}}'

          {{#USE_NPM}}
          - script: npm ci
            displayName: 'Install dependencies with npm'

          - script: npm run build
            displayName: 'Build application'

          - script: npm test
            displayName: 'Run tests'
          {{/USE_NPM}}

          {{#USE_YARN}}
          - script: yarn install --frozen-lockfile
            displayName: 'Install dependencies with Yarn'

          - script: yarn build
            displayName: 'Build application'

          - script: yarn test
            displayName: 'Run tests'
          {{/USE_YARN}}
          {{/USE_NODEJS}}

          {{#USE_DOTNET}}
          - task: UseDotNet@2
            inputs:
              version: '{{VERSION}}'
            displayName: 'Use .NET {{VERSION}}'

          - script: dotnet restore
            displayName: 'Restore NuGet packages'

          - script: dotnet build --configuration $(buildConfiguration)
            displayName: 'Build application'

          - script: dotnet test --configuration $(buildConfiguration)
            displayName: 'Run tests'

          - script: dotnet publish --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)
            displayName: 'Publish application'
          {{/USE_DOTNET}}

          {{#USE_DOCKER}}
          - task: Docker@2
            inputs:
              command: 'buildAndPush'
              repository: '{{DOCKER_REPOSITORY}}'
              dockerfile: '{{DOCKERFILE_PATH}}'
              containerRegistry: '{{CONTAINER_REGISTRY}}'
              tags: |
                $(Build.BuildId)
                latest
            displayName: 'Build and push Docker image'
          {{/USE_DOCKER}}

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: '{{ARTIFACT_NAME}}'
              publishLocation: 'Container'
            displayName: 'Publish build artifacts'

          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              mergeTestResults: true
            condition: succeededOrFailed()
            displayName: 'Publish test results'
