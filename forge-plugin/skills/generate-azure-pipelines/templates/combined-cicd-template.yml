# Combined CI/CD Pipeline for {{PROJECT_NAME}}
# Generated by Claude Code skill:generate-azure-pipelines
# Runtime: {{RUNTIME}} {{VERSION}}

trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: '{{VM_IMAGE}}'

variables:
  buildConfiguration: 'Release'
  {{#ADDITIONAL_VARIABLES}}
  {{KEY}}: '{{VALUE}}'
  {{/ADDITIONAL_VARIABLES}}

stages:
  # Build and Test Stage
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - template: pipelines/templates/build-job.yml

  # Deployment Stages
{{#ENVIRONMENTS}}
  - stage: Deploy{{ENVIRONMENT_NAME}}
    displayName: 'Deploy to {{ENVIRONMENT_DISPLAY_NAME}}'
    dependsOn: {{DEPENDS_ON}}
    {{#CONDITION}}
    condition: {{CONDITION}}
    {{/CONDITION}}
    jobs:
      - deployment: Deploy{{ENVIRONMENT_NAME}}Job
        displayName: 'Deploy to {{ENVIRONMENT_DISPLAY_NAME}}'
        environment: {{ENVIRONMENT_RESOURCE_NAME}}
        variables:
          - group: {{VARIABLE_GROUP}}
        strategy:
          runOnce:
            deploy:
              steps:
                - download: current
                  artifact: {{ARTIFACT_NAME}}
                  displayName: 'Download build artifacts'

                - template: pipelines/templates/deploy-job.yml
                  parameters:
                    serviceConnection: '{{SERVICE_CONNECTION}}'
                    resourceGroup: '{{RESOURCE_GROUP}}'
                    deploymentTarget: '{{DEPLOYMENT_TARGET}}'
                    artifactPath: '$(Pipeline.Workspace)/{{ARTIFACT_NAME}}'

{{/ENVIRONMENTS}}
