# Infrastructure as Code Pipeline for {{PROJECT_NAME}}
# Generated by Claude Code skill:generate-azure-pipelines
# Deploys Azure infrastructure using Bicep templates

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - .azure/bicep/**

pr:
  branches:
    include:
      - main
  paths:
    include:
      - .azure/bicep/**

pool:
  vmImage: 'ubuntu-latest'

variables:
  bicepPath: '.azure/bicep'
  {{#ADDITIONAL_VARIABLES}}
  {{KEY}}: '{{VALUE}}'
  {{/ADDITIONAL_VARIABLES}}

stages:
  - stage: ValidateBicep
    displayName: 'Validate Bicep Templates'
    jobs:
      - job: Validate
        displayName: 'Validate Bicep Syntax and Deployment'
        steps:
          - task: AzureCLI@2
            inputs:
              azureSubscription: '{{DEV_SERVICE_CONNECTION}}'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Building Bicep templates..."
                az bicep build --file $(bicepPath)/main.bicep

                echo "Validating deployment..."
                az deployment sub validate \
                  --location {{LOCATION}} \
                  --template-file $(bicepPath)/main.bicep \
                  --parameters $(bicepPath)/main.development.bicepparams
            displayName: 'Validate Bicep'

          {{#RUN_WHAT_IF}}
          - task: AzureCLI@2
            inputs:
              azureSubscription: '{{DEV_SERVICE_CONNECTION}}'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Running what-if analysis..."
                az deployment sub what-if \
                  --location {{LOCATION}} \
                  --template-file $(bicepPath)/main.bicep \
                  --parameters $(bicepPath)/main.development.bicepparams
            displayName: 'What-If Analysis'
          {{/RUN_WHAT_IF}}

{{#ENVIRONMENTS}}
  - stage: DeployInfra{{ENVIRONMENT_NAME}}
    displayName: 'Deploy Infrastructure to {{ENVIRONMENT_DISPLAY_NAME}}'
    dependsOn: {{DEPENDS_ON}}
    {{#CONDITION}}
    condition: {{CONDITION}}
    {{/CONDITION}}
    jobs:
      - deployment: DeployInfra{{ENVIRONMENT_NAME}}Job
        displayName: 'Deploy Infrastructure'
        environment: {{ENVIRONMENT_RESOURCE_NAME}}
        variables:
          - group: {{VARIABLE_GROUP}}
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                  displayName: 'Checkout repository'

                - task: AzureCLI@2
                  inputs:
                    azureSubscription: '{{SERVICE_CONNECTION}}'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Deploying infrastructure to {{ENVIRONMENT_DISPLAY_NAME}}..."
                      az deployment sub create \
                        --location {{LOCATION}} \
                        --template-file $(bicepPath)/main.bicep \
                        --parameters $(bicepPath)/main.{{ENVIRONMENT_BICEP_PARAMS}}.bicepparams \
                        --name "infra-{{ENVIRONMENT_SHORT}}-$(Build.BuildId)"
                  displayName: 'Deploy Bicep to {{ENVIRONMENT_DISPLAY_NAME}}'

                - task: AzureCLI@2
                  inputs:
                    azureSubscription: '{{SERVICE_CONNECTION}}'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Retrieving deployment outputs..."
                      az deployment sub show \
                        --name "infra-{{ENVIRONMENT_SHORT}}-$(Build.BuildId)" \
                        --query properties.outputs
                  displayName: 'Show deployment outputs'

{{/ENVIRONMENTS}}
