# CD Pipeline for {{PROJECT_NAME}}
# Generated by Claude Code skill:generate-azure-pipelines

trigger: none  # Triggered by CI pipeline completion or manually

resources:
  pipelines:
    - pipeline: buildPipeline
      source: '{{CI_PIPELINE_NAME}}'
      trigger:
        branches:
          include:
            - main
            - develop

pool:
  vmImage: '{{VM_IMAGE}}'

stages:
{{#ENVIRONMENTS}}
  - stage: Deploy{{ENVIRONMENT_NAME}}
    displayName: 'Deploy to {{ENVIRONMENT_DISPLAY_NAME}}'
    {{#DEPENDS_ON}}
    dependsOn: {{DEPENDS_ON_STAGE}}
    {{/DEPENDS_ON}}
    {{#CONDITION}}
    condition: {{CONDITION}}
    {{/CONDITION}}
    jobs:
      - deployment: Deploy{{ENVIRONMENT_NAME}}Job
        displayName: 'Deploy to {{ENVIRONMENT_DISPLAY_NAME}}'
        environment: {{ENVIRONMENT_RESOURCE_NAME}}
        variables:
          - group: {{VARIABLE_GROUP}}
          {{#CUSTOM_VARIABLES}}
          - name: {{KEY}}
            value: {{VALUE}}
          {{/CUSTOM_VARIABLES}}
        strategy:
          runOnce:
            deploy:
              steps:
                - download: buildPipeline
                  artifact: {{ARTIFACT_NAME}}
                  displayName: 'Download build artifacts'

                {{#DEPLOY_TO_FUNCTION_APP}}
                - task: AzureCLI@2
                  inputs:
                    azureSubscription: '{{SERVICE_CONNECTION}}'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az functionapp deployment source config-zip \
                        --resource-group {{RESOURCE_GROUP}} \
                        --name {{FUNCTION_APP_NAME}} \
                        --src $(Pipeline.Workspace)/buildPipeline/{{ARTIFACT_NAME}}/{{PACKAGE_FILE}}
                  displayName: 'Deploy to Azure Function App'
                {{/DEPLOY_TO_FUNCTION_APP}}

                {{#DEPLOY_TO_APP_SERVICE}}
                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: '{{SERVICE_CONNECTION}}'
                    appType: 'webAppLinux'
                    appName: '{{APP_SERVICE_NAME}}'
                    package: '$(Pipeline.Workspace)/buildPipeline/{{ARTIFACT_NAME}}/{{PACKAGE_FILE}}'
                    {{#USE_DEPLOYMENT_SLOT}}
                    deployToSlotOrASE: true
                    resourceGroupName: '{{RESOURCE_GROUP}}'
                    slotName: 'staging'
                    {{/USE_DEPLOYMENT_SLOT}}
                  displayName: 'Deploy to Azure App Service'

                {{#USE_DEPLOYMENT_SLOT}}
                - task: AzureAppServiceManage@0
                  inputs:
                    azureSubscription: '{{SERVICE_CONNECTION}}'
                    action: 'Swap Slots'
                    webAppName: '{{APP_SERVICE_NAME}}'
                    resourceGroupName: '{{RESOURCE_GROUP}}'
                    sourceSlot: 'staging'
                  displayName: 'Swap deployment slot'
                {{/USE_DEPLOYMENT_SLOT}}
                {{/DEPLOY_TO_APP_SERVICE}}

                {{#DEPLOY_TO_CONTAINER_INSTANCES}}
                - task: AzureCLI@2
                  inputs:
                    azureSubscription: '{{SERVICE_CONNECTION}}'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      az container create \
                        --resource-group {{RESOURCE_GROUP}} \
                        --name {{CONTAINER_NAME}} \
                        --image {{CONTAINER_REGISTRY}}/{{DOCKER_REPOSITORY}}:$(Build.BuildId) \
                        --registry-login-server {{CONTAINER_REGISTRY}} \
                        --registry-username $(registryUsername) \
                        --registry-password $(registryPassword) \
                        --dns-name-label {{CONTAINER_NAME}} \
                        --ports 80
                  displayName: 'Deploy to Azure Container Instances'
                {{/DEPLOY_TO_CONTAINER_INSTANCES}}

                {{#DEPLOY_TO_STATIC_WEB_APP}}
                - task: AzureStaticWebApp@0
                  inputs:
                    app_location: '{{APP_LOCATION}}'
                    api_location: '{{API_LOCATION}}'
                    output_location: '{{OUTPUT_LOCATION}}'
                    azure_static_web_apps_api_token: '$(staticWebAppToken)'
                  displayName: 'Deploy to Azure Static Web Apps'
                {{/DEPLOY_TO_STATIC_WEB_APP}}

                {{#RUN_SMOKE_TESTS}}
                - script: |
                    # Wait for deployment to be ready
                    sleep 30
                    # Run smoke tests
                    curl -f https://{{APP_URL}}/health || exit 1
                  displayName: 'Run smoke tests'
                {{/RUN_SMOKE_TESTS}}

{{/ENVIRONMENTS}}
