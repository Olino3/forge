# Dockerfile for {{FUNCTION_NAME}} Azure Function
# Generated by Claude Code skill:generate-azure-functions
# Runtime: {{RUNTIME}} {{VERSION}}

FROM {{BASE_IMAGE}}

# Create and set working directory
RUN mkdir -p /home/site/wwwroot && chmod -R 755 /home/site/wwwroot
WORKDIR /home/site/wwwroot

# Set Azure Functions environment variables
ENV AzureWebJobsScriptRoot=/home/site/wwwroot
ENV AzureFunctionsJobHost__Logging__Console__IsEnabled=true
ENV PYTHONPATH=/home/site/wwwroot
{{#USE_POETRY}}
ENV POETRY_HOME=/opt/poetry
ENV POETRY_VENV=/opt/poetry-venv
ENV POETRY_CACHE_DIR=/opt/.cache
{{/USE_POETRY}}

{{#INSTALL_SYSTEM_PACKAGES}}
# Install system dependencies
RUN apt-get update && apt-get install -y \
{{#SYSTEM_PACKAGES}}
    {{PACKAGE}} \
{{/SYSTEM_PACKAGES}}
    && rm -rf /var/lib/apt/lists/*

{{/INSTALL_SYSTEM_PACKAGES}}
{{#INSTALL_AZURE_CLI}}
# Install Azure CLI
RUN curl -sL https://aka.ms/InstallAzureCLIDeb | bash

{{/INSTALL_AZURE_CLI}}
{{#USE_POETRY}}
# Install Poetry in separate virtual environment
RUN python -m venv $POETRY_VENV \
    && $POETRY_VENV/bin/pip install -U pip setuptools \
    && $POETRY_VENV/bin/pip install poetry poetry-plugin-export

# Add poetry to PATH
ENV PATH="${PATH}:${POETRY_VENV}/bin"

{{/USE_POETRY}}
{{#HAS_LOCAL_PACKAGE}}
# Build local package in a temporary location
WORKDIR /tmp/{{LOCAL_PACKAGE_NAME}}
COPY {{LOCAL_PACKAGE_PATH}}/pyproject.toml {{LOCAL_PACKAGE_PATH}}/poetry.lock* ./
COPY {{LOCAL_PACKAGE_PATH}}/README.md ./
COPY {{LOCAL_PACKAGE_PATH}}/src ./src

# Build the package wheel
RUN poetry build

# Switch back to function directory
WORKDIR /home/site/wwwroot

# Create dist directory and copy the built wheel
RUN mkdir -p ./dist
RUN cp /tmp/{{LOCAL_PACKAGE_NAME}}/dist/*.whl ./dist/

{{/HAS_LOCAL_PACKAGE}}
{{#USE_POETRY}}
# Copy function dependency files
COPY functions/{{FUNCTION_NAME}}/pyproject.toml functions/{{FUNCTION_NAME}}/poetry.lock* ./

# Export requirements and install to system Python
RUN poetry export -f requirements.txt --output requirements.txt --without-hashes \
    && pip install --no-cache-dir -r requirements.txt{{#HAS_LOCAL_PACKAGE}} \
    && pip install --no-cache-dir ./dist/{{LOCAL_PACKAGE_NAME}}-*.whl{{/HAS_LOCAL_PACKAGE}}

{{/USE_POETRY}}
{{#USE_PIP}}
# Copy requirements file
COPY functions/{{FUNCTION_NAME}}/requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt{{#HAS_LOCAL_PACKAGE}} \
    && pip install --no-cache-dir ./dist/{{LOCAL_PACKAGE_NAME}}-*.whl{{/HAS_LOCAL_PACKAGE}}

{{/USE_PIP}}
# Copy function code
COPY functions/{{FUNCTION_NAME}}/ .

# Expose the default Azure Functions port
EXPOSE 80
