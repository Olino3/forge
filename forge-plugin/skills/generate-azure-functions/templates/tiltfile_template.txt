# Tiltfile for {{PROJECT_NAME}}
# Generated by Claude Code skill:generate-azure-functions

# Load environment variables from .env.local
load('ext://dotenv', 'dotenv')
dotenv('.env.local')

# Define service dependencies
RESOURCE_DEPENDENCIES = {
{{#FUNCTION_APPS}}
    '{{NAME}}': ['azurite', 'init-azurite'],
{{/FUNCTION_APPS}}
    'azurite': [],
    'init-azurite': ['azurite']
}

ALL_DEFINED_RESOURCE_NAMES = list(RESOURCE_DEPENDENCIES.keys())

def get_all_dependencies_for_selection(selected_services, dep_map):
    """
    Calculates the full list of services to run, including all transitive dependencies.
    """
    resources_to_enable = set()
    queue = list(selected_services)

    while queue:
        service = queue.pop(0)
        if service not in resources_to_enable and service in dep_map:
            resources_to_enable.add(service)
            for dep in dep_map[service]:
                if dep not in resources_to_enable:
                    queue.append(dep)
        elif service not in dep_map:
            print("Warning: Service '%s' is selected but not found in RESOURCE_DEPENDENCIES map." % service)

    return list(resources_to_enable)

# Define service selection
config.define_string_list('args', args=True)
cfg = config.parse()
requested_service_args = cfg.get('args', [])

if requested_service_args:
    processed_selection = []
    valid_service_inputs = ALL_DEFINED_RESOURCE_NAMES

    for arg in requested_service_args:
        if arg in ALL_DEFINED_RESOURCE_NAMES:
            if arg not in processed_selection:
                processed_selection.append(arg)
        else:
            print("Warning: Unknown service '%s' requested. It will be ignored." % arg)
            print("Known services: %s" % valid_service_inputs)

    if processed_selection:
        final_resources_to_run = get_all_dependencies_for_selection(processed_selection, RESOURCE_DEPENDENCIES)
        print("Tilt will attempt to run the following selected services and their dependencies: %s" % final_resources_to_run)
        config.set_enabled_resources(final_resources_to_run)
    else:
        print("No valid services were specified in the arguments: %s. No services will be enabled by default." % requested_service_args)
        config.set_enabled_resources([])

# Initialize Azurite storage emulator
local_resource(
    name='init-azurite',
    cmd='echo "Azurite initialization handled by Dockerfile entrypoint"',
    labels=['storage'],
    resource_deps=['azurite']
)

# Load Docker Compose configuration
docker_compose('.docker/docker-compose.dev.yml')

{{#FUNCTION_APPS}}
# Build the {{NAME}} Function container
docker_build(
    ref='{{PROJECT_NAME}}-{{NAME}}-dev',
    context='.',
    dockerfile='.docker/{{NAME}}/Dockerfile',
    ignore=['tests', '.git', '.venv', '**/.venv', '__pycache__', '**/__pycache__', '*.pyc', '**/*.pyc'{{#OTHER_FUNCTIONS}}, 'functions/{{OTHER_NAME}}'{{/OTHER_FUNCTIONS}}],
    live_update=[
        # Sync function code changes
        sync('./functions/{{NAME}}/', '/home/site/wwwroot/'),
{{#HAS_LOCAL_PACKAGE}}

        # Rebuild and reinstall local package when its source changes
        sync('{{LOCAL_PACKAGE_PATH}}/src/{{LOCAL_PACKAGE_NAME}}', '/tmp/{{LOCAL_PACKAGE_NAME}}/src/{{LOCAL_PACKAGE_NAME}}'),
        run(
            'cd /tmp/{{LOCAL_PACKAGE_NAME}} && poetry build && pip install --no-cache-dir --force-reinstall dist/*.whl',
            trigger=['{{LOCAL_PACKAGE_PATH}}/src/{{LOCAL_PACKAGE_NAME}}']
        ),
{{/HAS_LOCAL_PACKAGE}}
{{#USE_POETRY}}

        # Reinstall dependencies when poetry files change
        run(
            'poetry export -f requirements.txt --output requirements.txt --without-hashes && pip install --no-cache-dir -r requirements.txt',
            trigger=['./functions/{{NAME}}/poetry.lock', './functions/{{NAME}}/pyproject.toml']
        ),
{{/USE_POETRY}}
{{#USE_PIP}}

        # Reinstall dependencies when requirements.txt changes
        run(
            'pip install --no-cache-dir -r requirements.txt',
            trigger=['./functions/{{NAME}}/requirements.txt']
        ),
{{/USE_PIP}}

        restart_container()
    ]
)

{{/FUNCTION_APPS}}
# Build Azurite container
docker_build(
    ref='{{PROJECT_NAME}}-azurite',
    context='.',
    dockerfile='.docker/azurite/Dockerfile'
)

# Define resources for each service
{{#FUNCTION_APPS}}
dc_resource(
    name='{{NAME}}',
    labels=['functions'],
    links=['http://localhost:{{PORT}}'],
    resource_deps=['azurite', 'init-azurite']
)

{{/FUNCTION_APPS}}
dc_resource(
    name='azurite',
    labels=['storage'],
    links=[
        'http://localhost:10000',
        'http://localhost:10002'
    ]
)

print("""
Tilt environment is configuring...

=== HTTP Endpoints ===
{{#FUNCTION_APPS}}
- {{NAME}}: http://localhost:{{PORT}}/api/{route}
{{/FUNCTION_APPS}}

=== Azurite Storage ===
- Blob Storage:  http://localhost:10000
- Queue Storage: http://localhost:10001
- Table Storage: http://localhost:10002

=== Service Selection ===
If you ran 'tilt up' with specific service names (e.g., 'tilt up {{FIRST_FUNCTION_NAME}}'),
only those services and their dependencies will be started.
Otherwise, all services will be started.

=== Storage Resources ===
{{#BLOB_CONTAINERS}}
Container: {{NAME}}
{{/BLOB_CONTAINERS}}
{{#QUEUES}}
Queue: {{NAME}}
{{/QUEUES}}
{{#TABLES}}
Table: {{NAME}}
{{/TABLES}}
""")
