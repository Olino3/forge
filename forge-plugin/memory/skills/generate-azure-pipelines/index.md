# Memory Structure: generate-azure-pipelines

## Purpose

This directory stores **project-specific** configurations and learnings for Azure Pipelines generation. Each project gets its own subdirectory to track pipeline structure, Bicep resources, and customizations.

## Memory vs Context

- **Memory** (this directory): **Project-specific, dynamic** pipeline configurations and customizations
- **Context** (`../../../context/azure/`): **Shared, static** Azure Pipelines and Bicep standards

**Example**:
- Context says: "Here's the standard CI/CD pipeline pattern"
- Memory records: "In this project, we use separate CI/CD with 3 environments and custom deployment slots"

## Directory Structure

```
memory/skills/generate-azure-pipelines/
├── index.md                    # This file - explains memory structure
└── {project-name}/             # Per-project memory
    ├── pipeline_config.md      # Pipeline structure and architecture
    ├── generated_files.md      # List of all generated files
    ├── bicep_resources.md      # Infrastructure resources defined
    └── customizations.md       # User-specific customizations
```

## Memory Files Per Project

### 1. `pipeline_config.md`

**Purpose**: Record the pipeline architecture and configuration decisions

**Contains**:
- Pipeline architecture (separate CI/CD or combined)
- Runtime and version
- Build tool and commands
- Deployment target and environments
- Service connections required
- Variable groups needed
- Trigger configuration

**Example Content**:
```markdown
# Pipeline Configuration for my-app

**Generated**: 2025-11-18 16:00:00
**Skill Version**: generate-azure-pipelines v1.0.0

## Pipeline Architecture
- Type: Separate CI and CD
- CI Pipeline: ci-pipeline.yml
- CD Pipeline: cd-pipeline.yml
- IAC Pipeline: iac-pipeline.yml

## Project Details
- Runtime: Python 3.11
- Build Tool: Poetry
- Deployment Target: Azure Functions
- Environments: Development, Staging, Production

## Triggers
- CI: All branches (main, develop, feature/*)
- CD: Triggered by CI completion on main/develop
- IAC: Changes to .azure/bicep/**

## Service Connections
- my-app-development-connection (Development subscription)
- my-app-staging-connection (Staging subscription)
- my-app-production-connection (Production subscription)

## Variable Groups
- my-app-development-variables
- my-app-staging-variables
- my-app-production-variables
```

---

### 2. `generated_files.md`

**Purpose**: Track all files generated by this skill

**Contains**:
- Complete list of generated files
- File paths and purposes
- Templates used for generation
- Timestamps of generation/modification

**Example Content**:
```markdown
# Generated Files for my-app

**Last Generation**: 2025-11-18 16:00:00

## Pipeline Files

| File | Purpose | Template Used |
|------|---------|---------------|
| `.azure/ci-pipeline.yml` | CI pipeline | `ci-pipeline-template.yml` |
| `.azure/cd-pipeline.yml` | CD pipeline | `cd-pipeline-template.yml` |
| `.azure/iac-pipeline.yml` | Infrastructure pipeline | `iac-pipeline-template.yml` |

## Bicep Templates

| File | Purpose | Template Used |
|------|---------|---------------|
| `.azure/bicep/main.bicep` | Main infrastructure | `main-bicep-template.bicep` |
| `.azure/bicep/main.development.bicepparams` | Dev parameters | `bicepparams-template.bicep` |
| `.azure/bicep/main.staging.bicepparams` | Staging parameters | `bicepparams-template.bicep` |
| `.azure/bicep/main.production.bicepparams` | Prod parameters | `bicepparams-template.bicep` |
| `.azure/bicep/modules/storage-account.bicep` | Storage module | `storage-module-template.bicep` |
| `.azure/bicep/modules/function-app.bicep` | Function App module | `function-app-module-template.bicep` |

## Pipeline Templates

| File | Purpose | Template Used |
|------|---------|---------------|
| `.azure/pipelines/templates/build-job.yml` | Reusable build job | `build-job-template.yml` |
| `.azure/pipelines/templates/deploy-job.yml` | Reusable deploy job | `deploy-job-template.yml` |

## Variable Files

| File | Purpose |
|------|---------|
| `.azure/pipelines/variables/dev-variables.yml` | Development variables |
| `.azure/pipelines/variables/staging-variables.yml` | Staging variables |
| `.azure/pipelines/variables/prod-variables.yml` | Production variables |

## Documentation

| File | Purpose |
|------|---------|
| `.azure/docs/README.md` | Pipeline and infrastructure documentation |

## Generation History

- **2025-11-18 16:00:00**: Initial generation - All files created
```

---

### 3. `bicep_resources.md`

**Purpose**: Document Azure resources defined in Bicep templates

**Contains**:
- List of Azure resources
- Resource naming conventions
- Environment-specific configurations
- Resource SKUs per environment
- Resource dependencies

**Example Content**:
```markdown
# Bicep Resources for my-app

## Resource Naming Convention
- Prefix: `myapp`
- Pattern: `{prefix}-{environment}-{resource-type}`
- Unique suffix: Uses `uniqueString(resourceGroup().id)` where needed

## Resources Defined

### Storage Account
- **Name Pattern**: `st{uniqueString(rg.id)}`
- **SKU**:
  - Development: Standard_LRS
  - Staging: Standard_LRS
  - Production: Standard_GRS
- **Access Tier**: Hot
- **HTTPS Only**: Yes
- **Minimum TLS**: 1.2

### Function App
- **Name Pattern**: `myapp-{environment}-func`
- **Runtime**: Python 3.11
- **App Service Plan SKU**:
  - Development: B1 (Basic)
  - Staging: B1 (Basic)
  - Production: P1v2 (Premium V2)
- **OS**: Linux
- **Functions Version**: ~4

### Application Insights
- **Name Pattern**: `myapp-{environment}-appi`
- **Application Type**: web
- **Linked to Function App**: Yes

### Resource Group
- **Name Pattern**: `myapp-{environment}-rg`
- **Locations**:
  - Development: eastus
  - Staging: eastus
  - Production: eastus2

## Environment-Specific Parameters

### Development
- location: eastus
- resourcePrefix: myapp

### Staging
- location: eastus
- resourcePrefix: myapp

### Production
- location: eastus2
- resourcePrefix: myapp

## Resource Dependencies
1. Storage Account (independent)
2. Application Insights (independent)
3. App Service Plan (requires Resource Group)
4. Function App (requires Storage Account, App Service Plan, Application Insights)
```

---

### 4. `customizations.md`

**Purpose**: Track user-specific requirements and deviations from standard templates

**Contains**:
- Custom pipeline steps
- Modified deployment strategies
- Custom Bicep resources not in standard templates
- Specific variable configurations
- Special approval requirements

**Example Content**:
```markdown
# Customizations for my-app

## Custom Pipeline Steps

### CI Pipeline
- Added security scanning step (Snyk)
- Added code coverage reporting (Codecov)
- Custom linting with flake8 and mypy

### CD Pipeline
- Added database migration step before deployment
- Custom smoke tests after deployment
- Slack notification on production deployment

## Modified Deployment Strategy
- Production uses blue-green deployment via deployment slots
- Staging skipped - deploys directly from dev to prod
- Manual approval required for production

## Custom Bicep Resources

### Key Vault
- Added for storing application secrets
- Integrated with Function App via managed identity
- Access policies configured for development team

### Virtual Network
- Added VNet integration for Function App security
- Private endpoints for Storage Account
- Network Security Groups configured

## Variable Group Customizations

### Development Variables
- `DATABASE_CONNECTION_STRING`: Points to local PostgreSQL
- `FEATURE_FLAGS`: All features enabled

### Production Variables
- `DATABASE_CONNECTION_STRING`: Azure PostgreSQL connection (from Key Vault)
- `FEATURE_FLAGS`: Only stable features enabled
- `ENABLE_MONITORING`: true

## Approval Configuration
- Production environment requires approval from:
  - DevOps team lead
  - Product manager
- Staging environment auto-deploys without approval
```

---

## Workflow: Using Memory

### When Generating Pipelines

1. **Check for existing memory**: Look for `{project-name}/` directory
2. **If exists**: Load all memory files to understand previous configuration
3. **If not exists**: Will create after generation

### When Updating Pipelines

1. **Load memory**: Read existing configuration
2. **Identify changes**: Compare with new requirements
3. **Update memory**: Record new changes in all relevant files

### When Regenerating

1. **Load memory**: Understand previous decisions
2. **Confirm changes**: Ask user if they want to keep customizations
3. **Preserve or override**: Either keep customizations or regenerate from scratch
4. **Update memory**: Record regeneration with timestamp

## Memory Growth Pattern

Memory grows with each generation/update:
1. **First generation**: All 4 files created
2. **First update**: Customizations recorded
3. **Subsequent updates**: Customizations accumulate
4. **Regeneration**: Option to preserve or reset memory

## Related Files

- `../../../context/azure/azure_pipelines_overview.md` - Pipeline concepts
- `../../../context/azure/azure_pipelines_cicd_patterns.md` - CI/CD patterns
- `../../../context/azure/azure_bicep_overview.md` - Bicep overview
- `../../../skills/generate-azure-pipelines/SKILL.md` - Skill workflow
